import { NextResponse } from 'next/server'
import { 
  callGeminiAPI, 
  parseAnalysisResult, 
  handleAnalysisError, 
  AnalysisRequest, 
  AnalysisResult 
} from '../utils/ai-analyzer'

// 文章特化のスコアリング関数
async function getArticleEvaluationScores(analysisResult: AnalysisResult) {
  const scoringPrompt = `
あなたは、与えられた記事分析レポートを評価し、スコアを算出するチーフアナリストです。
以下のJSON形式の分析レポートを読み解き、5つの評価項目について、それぞれ100点満点で採点してください。

## 分析レポート
${JSON.stringify(analysisResult)}

## 評価基準（100点満点の定義）

### 100点の基準例：NewsPicksの「【リクルート出木場】100倍の結果を出す、成長戦略3つのポイント」レベル
- 企業トップへの独占インタビュー
- 読者視点のコンテンツ
- 社会的意義のあるコンテンツ
- 他では得られない一次情報と具体的事例
- 読者の記憶に残るユニークなフレーズ（「データ分析3原則」「n=3マーケティング」など） 
- 明日から使える実践的な示唆
- 完璧な編集・構成品質

## 評価項目と詳細基準

### 1. **技術力 (Technology)** (100点満点)
- **90-100点**: プロフェッショナルレベルの編集品質、完璧な構成、誤字脱字なし、非常に読みやすい
- **80-89点**: 高い編集品質、良い構成、ほぼ完璧な校正
- **70-79点**: 標準的な品質、構成に工夫あり
- **60-69点**: 基本的な品質は満たしている
- **50-59点**: 改善の余地がある

### 2. **専門性 (Expertise)** (100点満点)
- **90-100点**: 極めて希少な一次情報、深い取材力、具体的事例豊富、業界トップレベルの情報源
- **80-89点**: 価値ある情報、しっかりした取材、専門知識活用
- **70-79点**: 専門的内容、適切な情報収集
- **60-69点**: 基本的な専門性
- **50-59点**: 改善が必要

### 3. **創造性 (Creativity)** (100点満点)
- **90-100点**: 極めてユニークな切り口、記憶に残るフレーズ、革新的な構成
- **80-89点**: 独自の視点、工夫された構成
- **70-79点**: 面白い切り口、読者を引きつける要素
- **60-69点**: 基本的な工夫
- **50-59点**: 改善が必要

### 4. **影響力 (Impact)** (100点満点)
- **90-100点**: 読者の思考・行動を大きく変える力、強い感情的インパクト、明確な課題解決
- **80-89点**: 読者に良い影響、具体的示唆
- **70-79点**: 参考になる内容、一定の影響
- **60-69点**: 基本的な価値提供
- **50-59点**: 改善が必要

### 5. **総合評価 (Overall)** (100点満点)
上記4項目を総合し、記事全体の完成度と市場価値を評価

## 重要な出力指針
- 評価理由では、特定のメディアやブランド名との比較表現は使用しない
- 「○○レベルの〜がないため」のような表現は避ける
- 「独占的な情報」「記憶に残るフレーズ」「実践的な示唆」など、一般的な品質要素で評価する
- 各記事の特性を活かした建設的で適切な評価理由を提供する
- できるだけ肯定的な評価をしてください。

## 出力形式
以下のJSON形式で、スコアと評価の根拠を明確に示してください。
JSON以外のテキストは絶対に含めないでください。

{
  "scores": {
    "technology": { "score": 95, "reason": "分析レポート内の具体的な記述を根拠とした評価理由。構成、編集品質、読みやすさなどの技術的側面を評価。" },
    "expertise": { "score": 90, "reason": "分析レポート内の具体的な記述を根拠とした評価理由。情報の希少性、取材の深さ、専門知識の活用を評価。" },
    "creativity": { "score": 88, "reason": "分析レポート内の具体的な記述を根拠とした評価理由。独自の視点、革新的な表現、工夫された構成を評価。" },
    "impact": { "score": 85, "reason": "分析レポート内の具体的な記述を根拠とした評価理由。読者への影響力、実践的価値、課題解決力を評価。" },
    "overall": { "score": 90, "reason": "4項目を総合した評価理由。記事全体の完成度と市場価値を建設的に評価。" }
  }
}
`

  try {
    const generatedText = await callGeminiAPI(scoringPrompt, 0.3, 1024)
    const cleanedText = generatedText.replace(/```json\n?|\n?```/g, '').trim()
    return JSON.parse(cleanedText)
  } catch (error) {
    console.error('スコアリングエラー:', error)
    // フォールバック: デフォルトスコア
    return {
      scores: {
        technology: { score: 70, reason: 'スコアリング処理でエラーが発生したため、デフォルト値を使用' },
        expertise: { score: 70, reason: 'スコアリング処理でエラーが発生したため、デフォルト値を使用' },
        creativity: { score: 70, reason: 'スコアリング処理でエラーが発生したため、デフォルト値を使用' },
        impact: { score: 70, reason: 'スコアリング処理でエラーが発生したため、デフォルト値を使用' },
        overall: { score: 70, reason: 'スコアリング処理でエラーが発生したため、デフォルト値を使用' }
      }
    }
  }
}

export async function POST(body: any) {
  try {
    const { 
      description, 
      title, 
      url, 
      fullContent,
      productionNotes
    }: AnalysisRequest = body

    if (!description && !title && !url && !fullContent) {
      return NextResponse.json(
        { error: '分析する記事コンテンツが必要です' },
        { status: 400 }
      )
    }

    // 記事・ライティング専用の高精度分析プロンプト
    const articleAnalysisPrompt = `
あなたは経験豊富な編集者・ライティング専門家です。以下の記事作品を、編集・ライティングの観点から詳細に分析し、個別性の高い具体的なタグを10個以上生成してください。

記事タイトル: ${title || '未設定'}
記事URL: ${url || '未設定'}
記事説明・概要: ${description || '未設定'}
${productionNotes ? `制作メモ・目的・背景: ${productionNotes}` : ''}
${fullContent ? `記事本文: ${fullContent.substring(0, 3000)}${fullContent.length > 3000 ? '...(本文が長いため一部省略)' : ''}` : ''}

## 詳細分析観点

### 1. コンテンツ分類の細分化
- 記事の具体的なジャンル（ビジネス、技術解説、インタビュー、レビュー、オピニオン、ニュース解説、ハウツー、ケーススタディなど）
- 業界・分野の特定（IT、マーケティング、デザイン、経営、エンタメ、教育、ヘルスケア、金融など）
- 記事の形式（対談、Q&A、調査報告、体験談、比較記事、予測記事、解説記事など）

### 2. 文体・トーンの具体的特定
- 文体の特徴（専門的、親しみやすい、フォーマル、カジュアル、説得的、中立的、感情的など）
- 読み手との距離感（敬語、である調、だ・である調、です・ます調、話し言葉風など）
- 表現技法（ストーリーテリング、データ重視、引用多用、比喩表現、具体例重視など）

### 3. 対象読者の詳細分析
- 読者の専門レベル（初心者向け、中級者向け、上級者向け、専門家向け）
- 年代・属性（20代ビジネスパーソン、経営者、学生、主婦、シニア層など）
- 関心領域（キャリア志向、学習意欲、トレンド志向、実用性重視など）

### 4. 記事の機能・目的の特定
- 情報提供型、課題解決型、エンターテインメント型、啓発型、販促型
- 意識変容、行動変容、知識習得、スキル向上、意思決定支援

### 5. 技術的特徴の分析
- 記事構成（PREP法、起承転結、問題提起型、結論先出し型など）
- 情報の提示方法（データ活用、事例紹介、専門家コメント、図表使用など）
- エンゲージメント技法（疑問投げかけ、読者参加型、感情喚起など）

## タグ生成指針

以下の6つのカテゴリから合計10-15個の具体的タグを生成してください：

### A. ジャンル・専門分野系（3-4個）
記事の具体的なジャンルと専門分野

### B. 技術・手法系（2-3個）
ライティング技術、構成手法、表現技法

### C. スタイル・表現系（2-3個）
文体、トーン、表現スタイル

### D. 対象・用途系（2-3個）
ターゲット読者、利用シーン、目的

### E. 品質・レベル系（1-2個）
技術レベル、完成度、専門性

### F. 個別特徴系（1-2個）
この記事にしかない独自の特徴

以下の形式でJSONレスポンスを返してください：

{
  "tags": [
    "具体的ジャンル1", "具体的ジャンル2", "具体的ジャンル3", "具体的ジャンル4",
    "技術手法1", "技術手法2", "技術手法3",
    "スタイル特徴1", "スタイル特徴2",
    "対象用途1", "対象用途2",
    "品質レベル1", "個別特徴1"
  ],
  "keywords": ["専門用語1", "技術要素1", "業界用語1", "手法名1", "ツール名1"],
  "category": "推奨カテゴリ",
  "summary": "記事の核心と特徴を端的に表現（50文字以内）",
  "detailedAnalysis": {
    "genreClassification": "記事の具体的ジャンルと専門分野",
    "technicalAnalysis": "ライティング技術と構成手法の分析",
    "styleCharacteristics": "文体と表現の特徴分析",
    "targetAndPurpose": "対象読者と目的・用途の分析",
    "uniqueValueProposition": "この記事独自の価値と差別化要素",
    "professionalAssessment": "編集者視点での品質評価"
  },
  "tagClassification": {
    "genre": ["ジャンル系タグ1", "ジャンル系タグ2", "ジャンル系タグ3"],
    "technique": ["技術系タグ1", "技術系タグ2"],
    "style": ["スタイル系タグ1", "スタイル系タグ2"],
    "purpose": ["用途系タグ1", "用途系タグ2"],
    "quality": ["品質系タグ1"],
    "unique": ["個別特徴タグ1"]
  },
  "contentTypeAnalysis": "記事・ライティング作品としての特徴的な要素や評価ポイントの詳細分析",
  "strengths": {
    "creativity": [
      "独創的な視点、魅力的な文章表現、読者を引きつける構成など",
      "革新的なアプローチの詳細",
      "芸術的・創造的価値の分析"
    ],
    "expertise": [
      "深い取材力、専門知識の活用、正確な情報提供、SEO対策など",
      "業界知識・スキルの活用状況",
      "制作プロセスの高度さ",
      "品質管理・完成度の高さ"
    ],
    "impact": [
      "読者への価値提供、社会的影響、エンゲージメント創出など",
      "業界・市場への貢献度",
      "社会的価値・意義",
      "ビジネス・ブランド価値向上"
    ]
  },
  "improvementSuggestions": [
    "より具体的で実践的な改善提案1",
    "技術的・表現的向上のための提案2",
    "市場価値・競争力強化のための提案3"
  ],
  "professionalInsights": {
    "marketPositioning": "市場でのポジショニングと競合優位性",
    "scalabilityPotential": "このスタイル・手法の展開可能性",
    "industryTrends": "業界トレンドとの関連性"
  },
  "oneLinerSummary": "ライターの魅力を1〜2文で表現するキャッチコピー",
  "tagCloud": ["#深い洞察力", "#ストーリーテリング", "#専門家インタビュー", "#論理的構成力", "#読者への共感", "#課題解決思考"],
  "detailedMetrics": {
    "technology": {
      "score": 95,
      "headline": "難解なテーマも読破させる、磐石の論理構成力",
      "goodHighlight": "記事冒頭の『〜〜』という問いかけが読者を引き込み、…",
      "nextTip": "図解を追加すると理解と拡散力がさらに向上します"
    },
    "expertise": {
      "score": 92,
      "headline": "一次情報の深掘りで信頼性を担保",
      "goodHighlight": "業界トップへのインタビュー引用により、記事の独自性と信頼性を高めています。",
      "nextTip": "データソースへのリンクを追加すると専門性がさらに際立ちます。"
    },
    "creativity": {
      "score": 88,
      "headline": "逆説的アプローチで読者を魅了",
      "goodHighlight": "『常識を疑え』という見出しで興味を喚起し、先入観を打ち崩す構成が秀逸です。",
      "nextTip": "結末に読者への問いかけを追加し、余韻とシェアを促進しましょう。"
    },
    "impact": {
      "score": 85,
      "headline": "読者の行動を変える実践的示唆",
      "goodHighlight": "具体的なアクションプランを箇条書きで提示し、即実践につながる内容になっています。",
      "nextTip": "成功事例を追加し、説得力を補強するとさらに影響力が強まります。"
    },
    "overall": {
      "score": 90,
      "headline": "専門性と物語性が融合した高完成度コンテンツ"
    }
  },
  "learningPoints": ["論理展開のテンプレート化で再現性を確保", "一次情報へのアクセスで記事価値を高める"],
  "clientAppeal": ["読者エンゲージメント平均120%向上の実績", "専門外の読者にも理解される翻訳力"]
}

## 重要な注意事項：

1. **具体性の重視**: 抽象的ではなく、具体的で詳細なタグを生成
2. **個別性の確保**: その記事にしかない特徴的な要素を反映
3. **専門性の発揮**: 記事・ライティング分野の専門知識を活用した深い分析
4. **実用性の提供**: ライターが成長できる具体的な洞察
5. **タグ数の確保**: 必ず10個以上、最大15個程度のタグを生成
6. **バランスの維持**: 各カテゴリから適切にタグを配分
7. **汎用性の確保**: タグ全体の60〜70%は「ビジネス」「テクノロジー」「IoT」「ビジネスモデル解説」など発注者が直感的に理解できる短く汎用的なキーワードとし、残り30〜40%を記事固有の詳細タグとしてください
8. **ポジティブ・コーチング表現**: 欠点や悪い点という語を避け、「GOOD」「NEXT」の2段構成で伸びしろを提案するポジティブな言語を用いる。
9. **ライティング専門分析**: 記事の場合は、構成力、取材力、表現力、読者理解、SEO対策などの専門知識を活用した分析を行ってください。
10. **技術的詳細**: 使用しているライティング技法や構成手法について、具体的な技術名や手法名を特定し、その習熟度や活用方法を評価してください。
11. **市場適合性**: 記事のターゲット読者や市場を明確に特定し、その市場での価値や競合優位性を分析してください。

注意事項：
- タグは記事ジャンル、ライティングスタイル、対象読者層などのタグを基に、より具体的で細分化されたものを10-15個生成
- キーワードは記事・ライティング分野の技術的な要素や業界専門用語を含める
- カテゴリは「ウェブデザイン」「モバイルアプリ」「グラフィックデザイン」「記事・ライティング」「写真・映像」「その他」から選んでください
- 強みは以下の3つの観点から記事・ライティング作品として分析してください：
  * creativity: 独創的な視点、魅力的な文章表現、読者を引きつける構成など
  * expertise: 深い取材力、専門知識の活用、正確な情報提供、SEO対策など
  * impact: 読者への価値提供、社会的影響、エンゲージメント創出など
- 各観点で2-4個の強みを挙げ、具体的で実証的な内容にしてください
- 日本語で回答してください
- JSONフォーマット以外の文字は含めないでください
`

    // AI分析を実行
    const generatedText = await callGeminiAPI(articleAnalysisPrompt, 0.3, 4096)
    const analysisResult = parseAnalysisResult(generatedText)

    // 評価スコアを取得
    let evaluationScores = null
    try {
      evaluationScores = await getArticleEvaluationScores(analysisResult)
    } catch(scoringError) {
      console.error('Scoring Error:', scoringError)
    }

    return NextResponse.json({
      success: true,
      analysis: analysisResult,
      evaluation: evaluationScores,
      contentType: '記事・ライティング',
      analysisType: 'article_specialized_analysis',
      rawResponse: generatedText
    })

  } catch (error) {
    return handleAnalysisError(error)
  }
} 