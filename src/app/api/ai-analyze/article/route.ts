import { NextResponse } from "next/server";
import {
  callGeminiAPI,
  parseAnalysisResult,
  handleAnalysisError,
  fetchArticleContentFromUrl,
  AnalysisRequest,
} from "../utils/ai-analyzer";

// 文章特化のサマリー生成関数 - 削除済み

export async function POST(body: any) {
  try {
    const {
      description,
      title,
      url,
      fullContent,
      productionNotes,
    }: AnalysisRequest = body;

    if (!description && !title && !url && !fullContent) {
      return NextResponse.json(
        { error: "分析する記事コンテンツが必要です" },
        { status: 400 },
      );
    }

    // URLが提供されているが、fullContentがない場合はURLから記事本文を取得
    let articleContent = fullContent;
    if (url && !articleContent) {
      try {
        console.log("URLから記事本文を取得します:", url);
        articleContent = await fetchArticleContentFromUrl(url);
        console.log("記事本文の取得に成功:", articleContent.length, "文字");
      } catch (fetchError: any) {
        console.error("URLからの記事本文取得エラー:", fetchError);
        // エラーが発生しても、タイトルや説明文があれば分析を続行
        if (!description && !title) {
          return NextResponse.json(
            { error: `記事本文の取得に失敗しました: ${fetchError.message}` },
            { status: 400 },
          );
        }
        // タイトルや説明文があれば、それらを使って分析を続行
        articleContent = undefined;
      }
    }

    // ビジネス特化の高精度分析プロンプト
    const articleAnalysisPrompt = `
あなたはビジネスマーケティング・コンテンツ戦略の専門家です。以下の記事作品を、ビジネスコンテンツの観点から詳細に分析し、プロクリエイターの専門性を可視化する具体的なタグを10個以上生成してください。

記事タイトル: ${title || "未設定"}
記事URL: ${url || "未設定"}
記事説明・概要: ${description || "未設定"}
${productionNotes ? `制作メモ・目的・背景: ${productionNotes}` : ""}
${articleContent ? `記事本文: ${articleContent.substring(0, 3000)}${articleContent.length > 3000 ? "...(本文が長いため一部省略)" : ""}` : ""}

## コンテンツ分析の観点

この記事コンテンツを分析し、以下の3つの要素を抽出してください：

### ① 課題（problem）
このコンテンツが解決する課題を箇条書きで分析してください（2〜4項目）。
- 読者やクライアントが直面していた問題は何か
- コンテンツ制作時に解決する必要があった課題は何か
- 従来のアプローチでは解決できなかった点は何か
- 記事のテーマや背景から読み取れる課題を具体的に記述

**出力形式**: 各項目を「・」で始まる箇条書き形式で記述してください。
例: "・読者が直面していた課題1\n・コンテンツ制作時の課題2\n・従来のアプローチの問題点3"

### ② 解決策（solution）
その課題に対して、このコンテンツがどのような解決策を提示したかを箇条書きで分析してください（2〜4項目）。
- どのようなアプローチや手法を用いたか
- 制作プロセスや思考プロセスはどのようなものか
- 読者やクライアントにどのような価値を提供したか
- 専門性や経験をどのように活かしたか

**出力形式**: 各項目を「・」で始まる箇条書き形式で記述してください。
例: "・アプローチや手法1\n・制作プロセスの特徴2\n・専門性の活かし方3"

### ③ 成果（result）
このコンテンツがもたらした成果や、目的にどう貢献したかを箇条書きで分析してください（2〜4項目）。
- 定量的な成果（数値データ）があれば具体的に記述
- 読者やクライアントへの影響は何か
- 社会的な反響や評価はどうか
- 目的達成にどの程度貢献したか

**出力形式**: 各項目を「・」で始まる箇条書き形式で記述してください。数値データがあれば必ず含めてください。
例: "・218Picksを獲得\n・専門家からのコメントが寄せられた\n・イベントの認知度向上に貢献"

## タグ生成指針

以下の6つのカテゴリから合計10-15個の具体的タグを生成してください：

### A. ジャンル・専門分野系（2-4個）
記事の具体的なジャンルと専門分野

### B. 技術・手法系（2-3個）
ライティング技術、構成手法、表現技法

### C. スタイル・表現系（2-3個）
文体、トーン、表現スタイル

### D. 対象・用途系（2-3個）
ターゲット読者、利用シーン、目的

### E. 品質・レベル系（1-2個）
技術レベル、完成度、専門性

### F. 個別特徴系（1-2個）
この記事にしかない独自の特徴

以下の形式でJSONレスポンスを返してください：

{
  "tags": [
    "SaaS", "DX", "AI", "不動産テック", "リード獲得", "業務効率化", "経営者向け", "マーケター向け", "BtoB", "プロフェッショナル", "専門性", "実績重視", "課題解決", "データ分析", "ROI"
  ],
  "keywords": ["SaaS", "DX", "AI", "IoT", "クラウド", "API", "ROI", "KPI", "TCO", "PoC", "RFP", "リード獲得", "業務効率化", "デジタル変革"],
  "category": "記事・ライティング",
  "summary": "BtoBビジネス課題を解決する専門性の高いコンテンツ",
  "detailedAnalysis": {
    "genreClassification": "BtoBビジネスコンテンツ・専門記事",
    "technicalAnalysis": "論理的構成とデータ重視のライティング技術",
    "styleCharacteristics": "専門的で説得的な文体、意思決定者向けのトーン",
    "targetAndPurpose": "経営層・マーケター向けの課題解決型コンテンツ",
    "uniqueValueProposition": "業界専門知識と実績データに基づく信頼性の高い情報提供",
    "professionalAssessment": "BtoBマーケティングの専門知識を活用した高品質なコンテンツ"
  },
  "tagClassification": {
    "genre": ["SaaS", "DX", "AI", "不動産テック"],
    "technique": ["リード獲得", "業務効率化", "データ分析"],
    "style": ["経営者向け", "マーケター向け", "専門的"],
    "purpose": ["ビジネス", "プロフェッショナル", "課題解決"],
    "quality": ["専門性", "実績重視"],
    "unique": ["業界特化", "ROI重視"]
  },
  "contentTypeAnalysis": "ビジネスコンテンツとして、業界専門知識と実績データを活用した高品質な課題解決型記事",
  "strengths": {
    "creativity": [
      "業界トレンドを先取りした視点と独自の分析アプローチ",
      "複雑なビジネス課題を分かりやすく構造化する能力",
      "データとストーリーを組み合わせた説得力のある表現"
    ],
    "expertise": [
      "業界特有の専門用語と慣習への深い理解",
      "ビジネス意思決定プロセスと購買行動の知識",
      "定量的データの適切な活用と解釈力"
    ],
    "impact": [
      "読者のビジネス課題解決に直結する実践的価値提供",
      "意思決定者への影響力と行動変容の促進",
      "企業や組織のROI向上に貢献するコンテンツ戦略"
    ]
  },
  "improvementSuggestions": [
    "より具体的な導入事例と成功指標の追加",
    "競合分析と差別化ポイントの明確化",
    "読者の意思決定プロセスに沿った構成の最適化"
  ],
  "professionalInsights": {
    "marketPositioning": "ビジネス専門コンテンツクリエイターとしての市場でのポジショニング",
    "scalabilityPotential": "業界横断的な専門知識の展開可能性",
    "industryTrends": "DX、AI、SaaS等の技術トレンドとの高い関連性"
  },
  "oneLinerSummary": "ビジネス課題を解決する専門性と実績を兼ね備えたプロクリエイター",
  "tagCloud": ["#SaaS", "#DX", "#AI", "#不動産テック", "#リード獲得", "#業務効率化", "#経営者向け", "#マーケター向け", "#ビジネス", "#専門性"],
  "contentAnalysis": {
    "problemPurpose": "・イベントのテーマが「大企業でのテックリーダーの仕事の面白さ」という、従来のエンジニアキャリア観を覆す内容だったため、読者に新しい視点を提供する必要があった\n・LIXILとイオンという異なる業界の2人のリーダーの発言を、それぞれの専門性を活かしながら、かつ統一感のある記事として構成する必要があった",
    "targetAudience": "・大企業でキャリア形成を考える中堅〜シニアエンジニア\n・組織変革を担うCTO/CDOなどテックリーダー層\n・人材採用や育成に関わる経営企画・人事担当者",
    "solutionApproach": "・イベント当日のパネルディスカッションを詳細に取材し、各リーダーの発言を丁寧に整理\n・大企業ならではのデータ活用・人材育成・意思決定プロセスを3章構成で整理し、専門性と共感を両立\n・AI時代に必要なヒューマンスキル・調整力などの示唆を、ケーススタディ形式で言語化",
    "result": "・記事は多くのエンジニアやテックリーダーから注目を集め、218Picksを獲得\n・大企業でのテックリーダーの働き方に対する認識を変える記事として評価され、「大企業にもこういった素晴らしいCTOやCDOが増え始めている」といった専門家からのコメントも寄せられた\n・イベントの認知度向上と、大企業でのエンジニアキャリアへの関心喚起に貢献"
  },
  "learningPoints": ["業界専門知識の継続的なアップデート", "定量的成果の効果的な可視化手法"],
  "clientAppeal": ["ビジネスリード獲得率40%向上の実績", "経営層への影響力と意思決定サポート力"]
}

## 重要な注意事項：

1. **具体性の重視**: 抽象的ではなく、具体的で詳細なタグを生成
2. **個別性の確保**: その記事にしかない特徴的な要素を反映
3. **専門性の発揮**: 記事・ライティング分野の専門知識を活用した深い分析
4. **実用性の提供**: ライターが成長できる具体的な洞察
5. **タグ数の確保**: 必ず10個以上、最大15個程度のタグを生成
6. **バランスの維持**: 各カテゴリから適切にタグを配分
7. **汎用性の確保**: タグ全体の60〜70%は「ビジネス」「テクノロジー」「IoT」「ビジネスモデル解説」など発注者が直感的に理解できる短く汎用的なキーワードとし、残り30〜40%を記事固有の詳細タグとしてください
8. **コンテンツ分析の重要性**: contentAnalysisの「課題・目的」「想定読者」「解決策（切り口や構成）」「成果」は、この記事の価値を最も明確に示す要素です。記事のテーマ、制作背景、読者の反応などを総合的に分析し、具体的で説得力のある内容を記述してください。特に「成果」には定量的データ（数値）があれば必ず含めてください。
9. **ライティング専門分析**: 記事の場合は、構成力、取材力、表現力、読者理解、SEO対策などの専門知識を活用した分析を行ってください。
10. **技術的詳細**: 使用しているライティング技法や構成手法について、具体的な技術名や手法名を特定し、その習熟度や活用方法を評価してください。
11. **市場適合性**: 記事のターゲット読者や市場を明確に特定し、その市場での価値や競合優位性を分析してください。

注意事項：
- タグは記事ジャンル、ライティングスタイル、対象読者層などのタグを基に、より具体的で細分化されたものを10-15個生成
- キーワードは記事・ライティング分野の技術的な要素や業界専門用語を含める
- カテゴリは「ウェブデザイン」「モバイルアプリ」「グラフィックデザイン」「記事・ライティング」「写真・映像」「その他」から選んでください
- 強みは以下の3つの観点から記事・ライティング作品として分析してください：
  * creativity: 独創的な視点、魅力的な文章表現、読者を引きつける構成など
  * expertise: 深い取材力、専門知識の活用、正確な情報提供、SEO対策など
  * impact: 読者への価値提供、社会的影響、エンゲージメント創出など
- 各観点で2-4個の強みを挙げ、具体的で実証的な内容にしてください
- 日本語で回答してください
- JSONフォーマット以外の文字は含めないでください
`;

    // AI分析を実行
    const generatedText = await callGeminiAPI(articleAnalysisPrompt, 0.3, 4096);
    const analysisResult = parseAnalysisResult(generatedText);

    return NextResponse.json({
      success: true,
      analysis: analysisResult,
      contentType: "記事・ライティング",
      analysisType: "article_specialized_analysis",
      rawResponse: generatedText,
    });
  } catch (error) {
    return handleAnalysisError(error);
  }
}
