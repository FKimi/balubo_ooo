'use client'

import { useState, useEffect, Suspense } from 'react'
import { useAuth } from '@/contexts/AuthContext'
import { useSearchParams } from 'next/navigation'
import { Button } from '@/components/ui/button'
import { Header, MobileBottomNavigation } from '@/components/layout/header'
import { useWorkStatistics } from '@/hooks/useWorkStatistics'
import { WorksSection } from '@/features/report/components/WorksSection'
import { InputsSection } from '@/features/report/components/InputsSection'
import { ActivitySection } from '@/features/report/components/ActivitySection'
import { exportToPDF, exportScreenshotToPDF, exportComprehensiveReportToPDF } from '@/utils/pdfExport'
import { supabase } from '@/lib/supabase'
import type { WorkData } from '@/types/work'
import type { InputData } from '@/types/input'
import { Card, CardHeader, CardTitle, CardContent } from '@/components/ui/card'
import { calculateMonthlyProgress, generateTimeline } from '@/utils/activityStats'
import { OverallScoreGauge } from '@/features/report/components/OverallScoreGauge'

function ReportContent() {
  const { user } = useAuth()
  const searchParams = useSearchParams()
  const targetUserId = searchParams.get('userId') // URL„Éë„É©„É°„Éº„Çø„Åã„ÇâuserId„ÇíÂèñÂæó
  const [activeSection, setActiveSection] = useState<string>('outputs')
  const [works, setWorks] = useState<WorkData[]>([])
  const [inputs, setInputs] = useState<InputData[]>([])
  const [loading, setLoading] = useState(true)
  const [error, setError] = useState<string | null>(null)
  const [isExporting, setIsExporting] = useState(false)
  const [profile, setProfile] = useState<any>(null)
  const [showDetailedCards, setShowDetailedCards] = useState(false)

  // ÂêÑ‰ΩúÂìÅ„ÅÆAIÂàÜÊûêÁµêÊûú„Åã„ÇâÂâµÈÄ†ÊÄß„ÄÅÂ∞ÇÈñÄÊÄß„ÄÅÂΩ±ÈüøÂäõ„ÇíÊäΩÂá∫
  const generateComprehensiveAnalysis = () => {
    const analysisData = {
      creativity: { scores: [] as number[], insights: [] as string[], topWorks: [] as any[] },
      expertise: { scores: [] as number[], insights: [] as string[], topWorks: [] as any[] },
      impact: { scores: [] as number[], insights: [] as string[], topWorks: [] as any[] },
      technology: { scores: [] as number[], insights: [] as string[], topWorks: [] as any[] }
    }

    // ÂêÑ‰ΩúÂìÅ„ÅÆAIÂàÜÊûêÁµêÊûú„Åã„ÇâË©ï‰æ°„Çπ„Ç≥„Ç¢„ÇíÊäΩÂá∫
    works.forEach(work => {
      if (work.ai_analysis_result) {
        const analysis = typeof work.ai_analysis_result === 'string' 
          ? JSON.parse(work.ai_analysis_result) 
          : work.ai_analysis_result

        // Êñ∞„Åó„ÅÑË©ï‰æ°„Çπ„Ç≥„Ç¢Ôºàevaluation.scoresÔºâ„ÇíÂÑ™ÂÖà‰ΩøÁî®
        if (analysis.evaluation?.scores) {
          const scores = analysis.evaluation.scores

          // ÊäÄË°ìÂäõ„Çπ„Ç≥„Ç¢
          if (scores.technology?.score) {
            analysisData.technology.scores.push(scores.technology.score)
            analysisData.technology.topWorks.push({
              title: work.title,
              score: scores.technology.score,
              reason: scores.technology.reason,
              highlights: [scores.technology.reason]
            })
          }

          // Â∞ÇÈñÄÊÄß„Çπ„Ç≥„Ç¢
          if (scores.expertise?.score) {
            analysisData.expertise.scores.push(scores.expertise.score)
            analysisData.expertise.topWorks.push({
              title: work.title,
              score: scores.expertise.score,
              reason: scores.expertise.reason,
              highlights: [scores.expertise.reason]
            })
          }

          // ÂâµÈÄ†ÊÄß„Çπ„Ç≥„Ç¢
          if (scores.creativity?.score) {
            analysisData.creativity.scores.push(scores.creativity.score)
            analysisData.creativity.topWorks.push({
              title: work.title,
              score: scores.creativity.score,
              reason: scores.creativity.reason,
              highlights: [scores.creativity.reason]
            })
          }

          // ÂΩ±ÈüøÂäõ„Çπ„Ç≥„Ç¢
          if (scores.impact?.score) {
            analysisData.impact.scores.push(scores.impact.score)
            analysisData.impact.topWorks.push({
              title: work.title,
              score: scores.impact.score,
              reason: scores.impact.reason,
              highlights: [scores.impact.reason]
            })
          }
        }
        // „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØÔºöÊóßÂΩ¢Âºè„ÅÆÂ†¥Âêà„ÅØÂæìÊù•„ÅÆË®àÁÆó„Çí‰ΩøÁî®
        else if (analysis.strengths) {
          // ÂâµÈÄ†ÊÄßÂàÜÊûê
          if (analysis.strengths.creativity && analysis.strengths.creativity.length > 0) {
            const creativityScore = Math.min(analysis.strengths.creativity.length * 20 + 
              (analysis.tagClassification?.technique?.length || 0) * 10, 100)
            analysisData.creativity.scores.push(creativityScore)
            analysisData.creativity.insights.push(...analysis.strengths.creativity)
            analysisData.creativity.topWorks.push({
              title: work.title,
              score: creativityScore,
              highlights: analysis.strengths.creativity.slice(0, 2)
            })
          }

          // Â∞ÇÈñÄÊÄßÂàÜÊûê
          if (analysis.strengths.expertise && analysis.strengths.expertise.length > 0) {
            const expertiseScore = Math.min(analysis.strengths.expertise.length * 20 + 
              (analysis.keywords?.length || 0) * 5, 100)
            analysisData.expertise.scores.push(expertiseScore)
            analysisData.expertise.insights.push(...analysis.strengths.expertise)
            analysisData.expertise.topWorks.push({
              title: work.title,
              score: expertiseScore,
              highlights: analysis.strengths.expertise.slice(0, 2)
            })
          }

          // ÂΩ±ÈüøÂäõÂàÜÊûê
          if (analysis.strengths.impact && analysis.strengths.impact.length > 0) {
            const impactScore = Math.min(analysis.strengths.impact.length * 20 + 
              (analysis.tagClassification?.purpose?.length || 0) * 15, 100)
            analysisData.impact.scores.push(impactScore)
            analysisData.impact.insights.push(...analysis.strengths.impact)
            analysisData.impact.topWorks.push({
              title: work.title,
              score: impactScore,
              highlights: analysis.strengths.impact.slice(0, 2)
            })
          }
        }
      }
    })

    // ÂêÑÂàÜÈáé„ÅÆÁ∑èÂêà„Çπ„Ç≥„Ç¢„Å®Áµ±Ë®à„ÇíË®àÁÆó
    const processAnalysisData = (data: typeof analysisData.creativity, fieldName: string) => {
      const avgScore = data.scores.length > 0 ? 
        Math.round(data.scores.reduce((sum, score) => sum + score, 0) / data.scores.length) : 0
      
      const uniqueInsights = [...new Set(data.insights)].slice(0, 10)
      const topWorksRanked = data.topWorks
        .sort((a, b) => b.score - a.score)
        .slice(0, 5)

      // „Çπ„Ç≥„Ç¢„É¨„Éô„É´„ÅÆÂà§ÂÆö
      const getScoreLevel = (score: number) => {
        if (score >= 90) return { level: '„Ç®„Ç≠„Çπ„Éë„Éº„Éà', color: 'text-purple-600', bgColor: 'bg-purple-50', description: '„Éó„É≠„Éï„Çß„ÉÉ„Ç∑„Éß„Éä„É´„É¨„Éô„É´' }
        if (score >= 80) return { level: '‰∏äÁ¥öËÄÖ', color: 'text-blue-600', bgColor: 'bg-blue-50', description: 'È´ò„ÅÑÂìÅË≥™' }
        if (score >= 70) return { level: '‰∏≠Á¥öËÄÖ', color: 'text-green-600', bgColor: 'bg-green-50', description: 'Ê®ôÊ∫ñÁöÑ„Å™ÂìÅË≥™' }
        if (score >= 60) return { level: 'ÂàùÁ¥öËÄÖ', color: 'text-yellow-600', bgColor: 'bg-yellow-50', description: 'Âü∫Êú¨ÁöÑ„Å™ÂìÅË≥™' }
        return { level: '„Éì„ÇÆ„Éä„Éº', color: 'text-gray-600', bgColor: 'bg-gray-50', description: 'ÊîπÂñÑ„ÅåÂøÖË¶Å' }
      }

      return {
        averageScore: avgScore,
        scoreLevel: getScoreLevel(avgScore),
        totalInsights: uniqueInsights.length,
        insights: uniqueInsights,
        topWorks: topWorksRanked,
        trend: data.scores.length >= 3 ? 
          (data.scores.slice(-3).reduce((sum, score) => sum + score, 0) / 3) - 
          (data.scores.slice(0, 3).reduce((sum, score) => sum + score, 0) / 3) : 0,
        fieldName
      }
    }

    return {
      creativity: processAnalysisData(analysisData.creativity, 'ÂâµÈÄ†ÊÄß'),
      expertise: processAnalysisData(analysisData.expertise, 'Â∞ÇÈñÄÊÄß'),
      impact: processAnalysisData(analysisData.impact, 'ÂΩ±ÈüøÂäõ'),
      technology: processAnalysisData(analysisData.technology, 'ÊäÄË°ìÂäõ'),
      overall: {
        totalWorks: works.length,
        analyzedWorks: works.filter(w => w.ai_analysis_result).length,
        comprehensiveScore: Math.round(
          (analysisData.creativity.scores.reduce((sum, score) => sum + score, 0) +
           analysisData.expertise.scores.reduce((sum, score) => sum + score, 0) +
           analysisData.impact.scores.reduce((sum, score) => sum + score, 0) +
           analysisData.technology.scores.reduce((sum, score) => sum + score, 0)) / 
          Math.max(
            analysisData.creativity.scores.length + 
            analysisData.expertise.scores.length + 
            analysisData.impact.scores.length + 
            analysisData.technology.scores.length, 1
          )
        )
      }
    }
  }

  // ‰ΩúÂìÅÁµ±Ë®à„ÇíË®àÁÆó
  const workStats = useWorkStatistics(works)
  const hasInputs = inputs.length > 0
  const comprehensiveAnalysis = generateComprehensiveAnalysis()

  // „Çø„Éñ„ÅÆÂÆöÁæ©
  const tabs = [
    {
      id: 'outputs',
      label: '„Ç¢„Ç¶„Éà„Éó„ÉÉ„Éà',
      icon: 'üé®',
      disabled: works.length === 0
    },
    {
      id: 'inputs',
      label: '„Ç§„É≥„Éó„ÉÉ„Éà',
      icon: 'üìö',
      disabled: !hasInputs
    },
    {
      id: 'activity',
      label: '„Ç¢„ÇØ„ÉÜ„Ç£„Éì„ÉÜ„Ç£',
      icon: 'üìà',
      disabled: false
    },
    {
      id: 'analysis',
      label: 'Á∑èÂêàÂàÜÊûê',
      icon: 'üîç',
      disabled: works.filter(w => w.ai_analysis_result).length === 0
    }
  ]
  
  // „Éá„Éê„ÉÉ„Ç∞Áî®ÔºöÁµ±Ë®à„ÇíÁ¢∫Ë™ç
  console.log('„É¨„Éù„Éº„Éà„Éö„Éº„Ç∏Áµ±Ë®à:', {
    works: works.length,
    inputs: inputs.length,
    workStats: {
      totalWorks: workStats.totalWorks,
      totalWordCount: workStats.totalWordCount,
      roleDistribution: workStats.roleDistribution.length
    }
  })

  // Ë™çË®º„Éò„ÉÉ„ÉÄ„Éº„ÇíÂèñÂæó„Åô„Çã„Éò„É´„Éë„ÉºÈñ¢Êï∞
  const getAuthHeaders = async (): Promise<Record<string, string>> => {
    try {
      const { data: { session }, error } = await supabase.auth.getSession()
      
      if (error || !session?.access_token) {
        console.error('Ë™çË®º„Çª„ÉÉ„Ç∑„Éß„É≥ÂèñÂæó„Ç®„É©„Éº:', error)
        return {
          'Content-Type': 'application/json'
        }
      }
      
      return {
        'Authorization': `Bearer ${session.access_token}`,
        'Content-Type': 'application/json'
      }
    } catch (error) {
      console.error('Ë™çË®º„Éà„Éº„ÇØ„É≥ÂèñÂæó„Ç®„É©„Éº:', error)
      return {
        'Content-Type': 'application/json'
      }
    }
  }

  // „Éó„É≠„Éï„Ç£„Éº„É´ÊÉÖÂ†±„ÅÆÂèñÂæó
  const fetchProfile = async () => {
    try {
      const headers = await getAuthHeaders()
      const response = await fetch('/api/profile', { headers })
      if (response.ok) {
        const profileData = await response.json()
        setProfile(profileData)
      }
    } catch (error) {
      console.error('„Éó„É≠„Éï„Ç£„Éº„É´ÂèñÂæó„Ç®„É©„Éº:', error)
    }
  }

  useEffect(() => {
    const fetchData = async () => {
      // targetUserId„ÅåÊåáÂÆö„Åï„Çå„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÅØÂÖ¨Èñã„Éó„É≠„Éï„Ç£„Éº„É´„Éá„Éº„Çø„ÇíÂèñÂæó
      if (targetUserId) {
        try {
          setLoading(true)
          setError(null)

          const response = await fetch(`/api/public-profile?userId=${targetUserId}`)
          
          if (!response.ok) {
            throw new Error('ÂÖ¨Èñã„Éó„É≠„Éï„Ç£„Éº„É´„Éá„Éº„Çø„ÅÆÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü')
          }

          const data = await response.json()
          setProfile(data.profile)
          setWorks(data.works || [])
          setInputs(data.inputs || [])

        } catch (error) {
          console.error('ÂÖ¨Èñã„Éó„É≠„Éï„Ç£„Éº„É´„Éá„Éº„ÇøÂèñÂæó„Ç®„É©„Éº:', error)
          setError(error instanceof Error ? error.message : 'ÂÖ¨Èñã„Éó„É≠„Éï„Ç£„Éº„É´„Éá„Éº„Çø„ÅÆÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü')
        } finally {
          setLoading(false)
        }
        return
      }

      // ÈÄöÂ∏∏„ÅÆË™çË®º„É¶„Éº„Ç∂„ÉºÂêë„Åë„Éá„Éº„ÇøÂèñÂæó
      if (!user) return

      try {
        setLoading(true)
        setError(null)

        // „Éó„É≠„Éï„Ç£„Éº„É´ÊÉÖÂ†±„ÇíÂèñÂæó
        await fetchProfile()

        // Ë™çË®º„Éò„ÉÉ„ÉÄ„Éº„ÇíÂèñÂæó
        const headers = await getAuthHeaders()

        // ‰ΩúÂìÅ„Éá„Éº„Çø„Å®‰ΩúÂìÅÂàÜÊûê„Çí‰∏¶Ë°åÂèñÂæó
        const [worksResponse, inputsResponse] = await Promise.all([
          fetch('/api/works', { headers }),
          fetch('/api/inputs', { headers })
        ])

        if (!worksResponse.ok) {
          throw new Error('‰ΩúÂìÅ„Éá„Éº„Çø„ÅÆÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü')
        }

        const worksData = await worksResponse.json()
        console.log('ÂèñÂæó„Åó„Åü‰ΩúÂìÅ„Éá„Éº„Çø:', worksData)
        // API„É¨„Çπ„Éù„É≥„Çπ„ÅÆÊßãÈÄ†„Å´Âøú„Åò„Å¶ÈÖçÂàó„ÇíÊäΩÂá∫
        const worksArray = Array.isArray(worksData) ? worksData : (worksData?.works || [])
        setWorks(worksArray)
        console.log('Ë®≠ÂÆö„Åó„Åü‰ΩúÂìÅÈÖçÂàó:', worksArray.length, '‰ª∂')

        if (inputsResponse.ok) {
          const inputsData = await inputsResponse.json()
          console.log('ÂèñÂæó„Åó„Åü„Ç§„É≥„Éó„ÉÉ„Éà„Éá„Éº„Çø:', inputsData)
          // API„É¨„Çπ„Éù„É≥„Çπ„ÅÆÊßãÈÄ†„Å´Âøú„Åò„Å¶ÈÖçÂàó„ÇíÊäΩÂá∫
          const inputsArray = Array.isArray(inputsData) ? inputsData : (inputsData?.inputs || [])
          setInputs(inputsArray)
          console.log('Ë®≠ÂÆö„Åó„Åü„Ç§„É≥„Éó„ÉÉ„ÉàÈÖçÂàó:', inputsArray.length, '‰ª∂')
        }

      } catch (error) {
        console.error('„Éá„Éº„ÇøÂèñÂæó„Ç®„É©„Éº:', error)
        setError(error instanceof Error ? error.message : '„Éá„Éº„Çø„ÅÆÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü')
      } finally {
        setLoading(false)
      }
    }

    fetchData()
  }, [user, targetUserId])

  // ÂåÖÊã¨ÁöÑ„Å™„É¨„Éù„Éº„Éà„Éá„Éº„Çø„ÇíÊ∫ñÂÇô„Åô„ÇãÈñ¢Êï∞
  const prepareComprehensiveReportData = () => {
    // „Ç®„Ç≠„Çπ„Éë„Éº„Éà„É¨„Éô„É´Âà§ÂÆö
    const getExpertLevel = () => {
      if (works.length >= 10 && workStats.totalWordCount >= 50000) {
        return '„Ç®„Ç≠„Çπ„Éë„Éº„Éà'
      } else if (works.length >= 5 && workStats.totalWordCount >= 20000) {
        return '„Éó„É≠„Éï„Çß„ÉÉ„Ç∑„Éß„Éä„É´'
      } else if (works.length >= 3 && workStats.totalWordCount >= 5000) {
        return 'ÁµåÈ®ìËÄÖ'
      } else {
        return 'Êñ∞ÈÄ≤„ÇØ„É™„Ç®„Ç§„Çø„Éº'
      }
    }

    // ÂìÅË≥™„Çπ„Ç≥„Ç¢Ë®àÁÆó
    const calculateQualityScore = () => {
      const worksWithContent = works.filter(work => work.description && work.description.length > 50)
      const contentQualityRate = works.length > 0 ? (worksWithContent.length / works.length) * 100 : 0
      
      const inputsWithNotes = inputs.filter(input => input.notes && input.notes.length > 20)
      const inputQualityRate = inputs.length > 0 ? (inputsWithNotes.length / inputs.length) * 100 : 0

      const uniqueRoles = new Set()
      works.forEach(work => {
        if (work.roles && Array.isArray(work.roles)) {
          work.roles.forEach(role => uniqueRoles.add(role))
        }
      })

      // 100ÁÇπÊ∫ÄÁÇπ„ÅßË®àÁÆó
      const contentScore = Math.min((contentQualityRate / 100) * 30, 30)
      const inputScore = Math.min((inputQualityRate / 100) * 20, 20)
      const roleScore = Math.min((uniqueRoles.size / 10) * 25, 25)
      const worksScore = Math.min((works.length / 20) * 25, 25)

      return Math.round(contentScore + inputScore + roleScore + worksScore)
    }

    // „Çø„Ç∞ÂàÜÂ∏É
    const getTagDistribution = () => {
      const tagCount: { [key: string]: number } = {}
      works.forEach(work => {
        if (work.tags && Array.isArray(work.tags)) {
          work.tags.forEach(tag => {
            tagCount[tag] = (tagCount[tag] || 0) + 1
          })
        }
      })
      return tagCount
    }

    // „Ç∏„É£„É≥„É´ÂàÜÂ∏É
    const getGenreDistribution = () => {
      const genreCount: { [key: string]: number } = {}
      inputs.forEach(input => {
        if (input.genres && Array.isArray(input.genres)) {
          input.genres.forEach(genre => {
            genreCount[genre] = (genreCount[genre] || 0) + 1
          })
        }
      })
      return genreCount
    }

    const favoriteInputs = inputs.filter(input => input.favorite)
    const favoriteRate = inputs.length > 0 ? (favoriteInputs.length / inputs.length) * 100 : 0

    const tagDistribution = getTagDistribution()
    const genreDistribution = getGenreDistribution()
    const topTags = Object.entries(tagDistribution)
      .sort(([, a], [, b]) => b - a)
      .slice(0, 8)
      .map(([tag]) => tag)

    const topGenres = Object.entries(genreDistribution)
      .sort(([, a], [, b]) => b - a)
      .slice(0, 6)
      .map(([genre]) => genre)

    return {
      profile: {
        displayName: profile?.display_name || user?.user_metadata?.display_name || '„É¶„Éº„Ç∂„Éº',
        bio: profile?.bio,
        skills: profile?.skills || [],
        location: profile?.location,
        website: profile?.website
      },
      overview: {
        expertLevel: getExpertLevel(),
        qualityScore: calculateQualityScore(),
        totalWorks: works.length,
        totalWordCount: workStats.totalWordCount,
        avgWordCount: works.length > 0 ? Math.round(workStats.totalWordCount / works.length) : 0,
        contentQualityRate: works.length > 0 ? (works.filter(w => w.description && w.description.length > 50).length / works.length) * 100 : 0,
        favoriteRate,
        avgInputRating: favoriteRate,
        availableRoles: new Set(works.flatMap(w => w.roles || [])).size,
        strengths: [
          `ÂÆüÁ∏æË±äÂØåÔºà${works.length}‰ΩúÂìÅ„ÅÆÂà∂‰ΩúÁµåÈ®ìÔºâ`,
          `Â≠¶ÁøíÊÑèÊ¨≤Êó∫ÁõõÔºà${inputs.length}‰ª∂„ÅÆ„Ç§„É≥„Éó„ÉÉ„ÉàË®òÈå≤Ôºâ`,
          favoriteRate > 20 ? 'Âé≥ÈÅ∏„Åó„Åü„Ç≥„É≥„ÉÜ„É≥„ÉÑÔºà„ÅäÊ∞ó„Å´ÂÖ•„ÇäÁéá20%‰ª•‰∏äÔºâ' : 'ÂπÖÂ∫É„ÅÑ„Ç≥„É≥„ÉÜ„É≥„ÉÑÊëÇÂèñ',
          workStats.totalWordCount > 20000 ? 'Ë±äÂØå„Å™ÊñáÁ´†ÂäõÔºà2‰∏áÊñáÂ≠ó‰ª•‰∏ä„ÅÆÂü∑Á≠ÜÔºâ' : 'Á∂ôÁ∂öÁöÑ„Å™Ââµ‰ΩúÊ¥ªÂãï',
          topTags.length > 5 ? 'Â§öÊßò„Å™„Çπ„Ç≠„É´„Çª„ÉÉ„Éà' : 'Â∞ÇÈñÄÂàÜÈáé„Å∏„ÅÆÈõÜ‰∏≠'
        ]
      },
      worksAnalysis: {
        works: works.slice(0, 12),
        genreDistribution: {},
        tagDistribution,
        monthlyProgress: calculateMonthlyProgress(works, inputs).map(m => ({ month: m.month, count: m.works })),
        qualityMetrics: {
          avgWordCount: works.length > 0 ? Math.round(workStats.totalWordCount / works.length) : 0,
          completionRate: works.length > 0 ? (works.filter(w => w.description && w.description.length > 20).length / works.length) * 100 : 0,
          tagVariety: topTags.length
        }
      },
      inputsAnalysis: {
        inputs: inputs.slice(0, 10),
        genrePreferences: genreDistribution,
        ratingDistribution: {},
        monthlyInputs: calculateMonthlyProgress(works, inputs).map(m => ({ month: m.month, count: m.inputs })),
        learningInsights: {
          totalInputs: inputs.length,
          favoriteRate,
          avgRating: favoriteRate,
          topGenres
        }
      },
      growthInsights: {
        timeline: generateTimeline(works, inputs),
        productivityTrends: calculateMonthlyProgress(works, inputs),
        skillEvolution: topTags.slice(0, 8).map(tag => ({
          skill: tag,
          frequency: tagDistribution[tag] || 0,
          trend: 'stable' as const
        }))
      },
      comprehensiveAnalysis: generateComprehensiveAnalysis()
    }
  }

  // PDFÂá∫ÂäõÊ©üËÉΩ
  const handleExportPDF = async (type: 'structured' | 'screenshot' | 'comprehensive' = 'comprehensive') => {
    try {
      setIsExporting(true)

      if (type === 'comprehensive') {
        // ÂåÖÊã¨ÁöÑ„Å™„É¨„Éù„Éº„ÉàPDFÂá∫ÂäõÔºà4„Çª„ÇØ„Ç∑„Éß„É≥Áµ±ÂêàÔºâ
        const comprehensiveData = prepareComprehensiveReportData()
        await exportComprehensiveReportToPDF(comprehensiveData)
      } else if (type === 'structured') {
        // ÂæìÊù•„ÅÆÊßãÈÄ†Âåñ„Åï„Çå„ÅüPDFÂá∫Âäõ
        const topTags = () => {
          const tagCount: { [key: string]: number } = {}
          works.forEach(work => {
            if (work.tags && Array.isArray(work.tags)) {
              work.tags.forEach(tag => {
                tagCount[tag] = (tagCount[tag] || 0) + 1
              })
            }
          })
          return Object.entries(tagCount)
            .sort(([, a], [, b]) => b - a)
            .slice(0, 8)
            .map(([tag]) => tag)
        }

        const topGenres = () => {
          const genreCount: { [key: string]: number } = {}
          inputs.forEach(input => {
            if (input.genres && Array.isArray(input.genres)) {
              input.genres.forEach(genre => {
                genreCount[genre] = (genreCount[genre] || 0) + 1
              })
            }
          })
          return Object.entries(genreCount)
            .sort(([, a], [, b]) => b - a)
            .slice(0, 6)
            .map(([genre]) => genre)
        }

        const favoriteInputs = inputs.filter(input => input.favorite)
        const favoriteRate = inputs.length > 0 ? (favoriteInputs.length / inputs.length) * 100 : 0

        const exportData = {
          profile: {
            displayName: profile?.display_name || user?.user_metadata?.display_name || '„É¶„Éº„Ç∂„Éº',
            bio: profile?.bio,
            skills: profile?.skills || [],
            location: profile?.location,
            website: profile?.website
          },
          works: works.slice(0, 10), // ÊúÄÊñ∞10‰ª∂
          inputs,
          stats: {
            totalWorks: works.length,
            totalWordCount: workStats.totalWordCount,
            favoriteRate,
            avgRating: favoriteRate,
            topGenres: topGenres(),
            topTags: topTags()
          }
        }

        await exportToPDF(exportData)
      } else {
        // „Çπ„ÇØ„É™„Éº„É≥„Ç∑„Éß„ÉÉ„ÉàÂûãPDFÂá∫Âäõ
        await exportScreenshotToPDF('report-content')
      }

    } catch (error) {
      console.error('PDFÂá∫Âäõ„Ç®„É©„Éº:', error)
      alert(error instanceof Error ? error.message : 'PDFÂá∫Âäõ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü')
    } finally {
      setIsExporting(false)
    }
  }

  // Á∑èÂêàÂàÜÊûê„Çª„ÇØ„Ç∑„Éß„É≥„Çí„É¨„É≥„ÉÄ„É™„É≥„Ç∞
  const renderComprehensiveAnalysisSection = () => {
    if (works.length === 0 && inputs.length === 0) {
      return (
        <Card>
          <CardContent className="p-8 text-center text-gray-500">
            <p>„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ</p>
          </CardContent>
        </Card>
      )
    }

    // „Çø„Ç∞„ÇíÁµ±ÂêàÈõÜË®à
    const tagCount: Record<string, number> = {}
    ;[...works, ...inputs].forEach((item: any) => {
      if (Array.isArray(item.tags)) {
        item.tags.forEach((tag: string) => {
          tagCount[tag] = (tagCount[tag] || 0) + 1
        })
      }
    })

    const topTags = Object.entries(tagCount)
      .sort(([, a], [, b]) => b - a)
      .slice(0, 10)

    // ÂÇæÂêëÊñáÁîüÊàê
    const tendencySentences = () => {
      if (topTags.length === 0) return ['„Éá„Éº„Çø‰∏çË∂≥„ÅÆ„Åü„ÇÅÂÇæÂêë„ÇíÁâπÂÆö„Åß„Åç„Åæ„Åõ„Çì']
      return topTags.slice(0, 5).map(([tag]) => `„Äå${tag}„Äç„Å´Âº∑„ÅÑÈñ¢ÂøÉ„ÉªÂ∞ÇÈñÄÊÄß„ÅåË¶ã„Çâ„Çå„Åæ„Åô`)
    }

    return (
      <Card>
        <CardContent className="space-y-8">
          {/* Á∑èÂêàË©ï‰æ° */}
          <div className="grid md:grid-cols-3 gap-6 items-center">
            <div className="col-span-1 bg-gradient-to-r from-indigo-50 to-blue-50 rounded-xl p-4 border border-indigo-200 flex items-center justify-center">
              <OverallScoreGauge score={comprehensiveAnalysis.overall.comprehensiveScore} />
            </div>
            <div className="col-span-2 text-sm text-indigo-800">
              <p className="mb-1 font-semibold text-gray-900">Á∑èÂêà„Çπ„Ç≥„Ç¢</p>
              <p className="text-3xl font-bold text-indigo-700 mb-2">{comprehensiveAnalysis.overall.comprehensiveScore}</p>
              <p>
                ÂàÜÊûêÂØæË±°‰ΩúÂìÅ {comprehensiveAnalysis.overall.analyzedWorks} ‰ª∂ / ÂÖ®{comprehensiveAnalysis.overall.totalWorks} ‰ª∂„ÅÆÂπ≥Âùá„Çπ„Ç≥„Ç¢„Åß„Åô„ÄÇ
              </p>
            </div>
          </div>

          {/* ÂÇæÂêë */}
          <div className="bg-white rounded-xl border border-gray-200 p-6 shadow-sm">
            <h3 className="text-lg font-semibold text-gray-900 mb-4 flex items-center gap-2">
              <svg className="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8c-1.657 0-3 1.567-3 3.5S10.343 15 12 15s3-1.567 3-3.5S13.657 8 12 8z" />
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9c.828 0 1.5.895 1.5 2s-.672 2-1.5 2-1.5-.895-1.5-2 .672-2 1.5-2zM5 9c.828 0 1.5.895 1.5 2S5.828 13 5 13s-1.5-.895-1.5-2S4.172 9 5 9z" />
              </svg>
              „ÇØ„É™„Ç®„Ç§„Çø„Éº„ÅÆÂÇæÂêë
            </h3>
            <ul className="list-disc pl-6 space-y-1 text-gray-700 text-sm">
              {tendencySentences().map((t, idx) => (
                <li key={idx}>{t}</li>
              ))}
            </ul>
          </div>

          {/* top tags („Éê„ÉÉ„Ç∏Ë°®Á§∫) */}
          {topTags.length > 0 && (
            <div className="bg-white rounded-xl border border-gray-200 p-6 shadow-sm">
              <h3 className="text-lg font-semibold text-gray-900 mb-4 flex items-center gap-2">
                <svg className="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 3v18h18" />
                </svg>
                È†ªÂá∫„Çø„Ç∞ Top10
              </h3>
              <div className="flex flex-wrap gap-2">
                {topTags.map(([name, count]) => (
                  <span key={name} className="inline-flex items-center px-3 py-1 rounded-full text-sm bg-blue-100 text-blue-800">
                    #{name}
                    <span className="ml-1 text-xs text-gray-600">{count}</span>
                  </span>
                ))}
              </div>
            </div>
          )}
        </CardContent>
      </Card>
    )
  }

  // Ë™çË®º„ÉÅ„Çß„ÉÉ„ÇØÔºà‰ªñ„ÅÆ„É¶„Éº„Ç∂„Éº„ÅÆ„É¨„Éù„Éº„Éà„ÇíË¶ã„ÇãÂ†¥Âêà„ÅØË™çË®º‰∏çË¶ÅÔºâ
  if (!user && !targetUserId) {
    return (
      <div className="min-h-screen bg-base-light-gray">
        <Header />
        <div className="flex items-center justify-center min-h-screen">
          <div className="text-center">
            <h2 className="text-xl font-semibold text-gray-700 mb-2">„É≠„Ç∞„Ç§„É≥„ÅåÂøÖË¶Å„Åß„Åô</h2>
            <p className="text-gray-500">„É¨„Éù„Éº„ÉàÊ©üËÉΩ„ÇíÂà©Áî®„Åô„Çã„Å´„ÅØ„É≠„Ç∞„Ç§„É≥„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ</p>
          </div>
        </div>
        <MobileBottomNavigation />
      </div>
    )
  }

  // „É≠„Éº„Éá„Ç£„É≥„Ç∞Áä∂ÊÖã
  if (loading) {
    return (
      <div className="min-h-screen bg-base-light-gray">
        <Header />
        <div className="flex items-center justify-center min-h-screen">
          <div className="text-center">
            <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-accent-dark-blue mx-auto mb-4"></div>
            <p className="text-gray-600">„É¨„Éù„Éº„Éà„Çí‰ΩúÊàê‰∏≠...</p>
          </div>
        </div>
        <MobileBottomNavigation />
      </div>
    )
  }

  // „Ç®„É©„ÉºÁä∂ÊÖã
  if (error) {
    return (
      <div className="min-h-screen bg-base-light-gray">
        <Header />
        <div className="flex items-center justify-center min-h-screen">
          <div className="text-center">
            <h2 className="text-xl font-semibold text-red-600 mb-2">„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü</h2>
            <p className="text-gray-500 mb-4">{error}</p>
            <Button onClick={() => window.location.reload()}>ÂÜçË™≠„ÅøËæº„Åø</Button>
          </div>
        </div>
        <MobileBottomNavigation />
      </div>
    )
  }

  return (
    <div className="min-h-screen bg-base-light-gray">
      <Header />
      
      <main className="pb-16 md:pb-0">
        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6 sm:py-8">
          {/* „Éò„ÉÉ„ÉÄ„Éº */}
          <div className="bg-white shadow-sm border border-gray-200 rounded-lg p-6 mb-6">
            <div className="flex items-center justify-between">
              <div>
                <h1 className="text-2xl font-bold text-gray-900">
                  {targetUserId ? `${profile?.display_name || '„ÇØ„É™„Ç®„Ç§„Çø„Éº'}„ÅÆÊ¥ªÂãï„É¨„Éù„Éº„Éà` : 'Ê¥ªÂãï„É¨„Éù„Éº„Éà'}
                </h1>
                <p className="text-gray-600 mt-1">
                  ‰ΩúÂìÅÂà∂‰Ωú„Å®„Ç§„É≥„Éó„ÉÉ„Éà„Éá„Éº„Çø„ÇíÂü∫„Å´„Åó„ÅüË©≥Á¥∞ÂàÜÊûê
                </p>
              </div>

            </div>
          </div>

          {/* „Éä„Éì„Ç≤„Éº„Ç∑„Éß„É≥ */}
          <div className="mb-6 sm:mb-8">
            {/* „Éá„Çπ„ÇØ„Éà„ÉÉ„ÉóÁî®„Çø„Éñ„Éä„Éì„Ç≤„Éº„Ç∑„Éß„É≥ */}
            <div className="hidden sm:block">
              <div className="hidden md:flex space-x-1 bg-gray-100 rounded-lg p-1">
                {tabs.map((section) => (
                  <button
                    key={section.id}
                    onClick={() => setActiveSection(section.id)}
                    disabled={section.disabled}
                    className={`flex items-center space-x-2 px-4 py-2 rounded-md text-sm font-medium transition-colors ${
                      activeSection === section.id
                        ? 'bg-white text-gray-900 shadow-sm'
                        : section.disabled
                        ? 'text-gray-400 cursor-not-allowed'
                        : 'text-gray-600 hover:text-gray-900 hover:bg-white hover:shadow-sm'
                    }`}
                  >
                    <span>{section.icon}</span>
                    <span className="hidden md:inline">{section.label}</span>
                    {section.disabled && <span className="text-xs">(„Éá„Éº„Çø„Å™„Åó)</span>}
                  </button>
                ))}
              </div>
            </div>

            {/* „É¢„Éê„Ç§„É´Áî®„Éâ„É≠„ÉÉ„Éó„ÉÄ„Ç¶„É≥ */}
            <div className="sm:hidden">
              <select
                value={activeSection}
                onChange={(e) => setActiveSection(e.target.value)}
                className="w-full bg-white border border-gray-300 rounded-lg px-4 py-3 text-sm font-medium text-gray-700 shadow-sm focus:border-accent-dark-blue focus:ring-1 focus:ring-accent-dark-blue"
              >
                {tabs.map((section) => (
                  <option key={section.id} value={section.id} disabled={section.disabled}>
                    {section.label}
                  </option>
                ))}
              </select>
            </div>
          </div>

          {/* „É°„Ç§„É≥„Ç≥„É≥„ÉÜ„É≥„ÉÑ */}
          <div id="report-content" className="space-y-6">
            {activeSection === 'outputs' && <WorksSection works={works} workStats={workStats} analysis={comprehensiveAnalysis} />}
            {activeSection === 'inputs' && <InputsSection inputs={inputs} />}
            {activeSection === 'activity' && (
              <ActivitySection works={works} inputs={inputs} />
            )}
            {activeSection === 'analysis' && renderComprehensiveAnalysisSection()}
          </div>


        </div>
      </main>

      <MobileBottomNavigation />
    </div>
  )
}

export default function ReportPage() {
  return (
    <Suspense fallback={
      <div className="min-h-screen bg-base-light-gray">
        <div className="flex items-center justify-center min-h-screen">
          <div className="text-center">
            <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-accent-dark-blue mx-auto mb-4"></div>
            <p className="text-gray-600">„É¨„Éù„Éº„Éà„ÇíË™≠„ÅøËæº„Åø‰∏≠...</p>
          </div>
        </div>
      </div>
    }>
      <ReportContent />
    </Suspense>
  )
} 